<html>
	<head>
		<title>Admin View</title>
		<link rel="stylesheet" href="css/bootstrap.min.css"/>
        <link rel="stylesheet" href="css/bootstrap-theme.css" />
        <link rel="stylesheet" href="css/style.css" />
		<script src="js/jquery.js"></script>
		<script src="js/bootstrap.min.js" type="text/javascript"></script>
		<script src="js/script.js"></script>
	</head>
	<body>
		<div id="top">
			<span id="logo">Payroll Manager</span>
			<button type="button" style="width:100px;height:40px;margin-right:50px" class="btn btn-primary dropdown-toggle menu" data-toggle="dropdown">
                    <span id="username">user</span> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu menu" role="menu">
                    <li><a href="#">Profile</a></li>
                    <li><a href="#">Edit Details</a></li>
                    <li id="signOut"><a href="#">Sign out</a></li>
                </ul>
		</div>
		<div id="test"></div>
		<div class="container-fluid">
			<div class="row">
				<div class="col-lg-3 col-md-3 col-sm-3" id="panel">
					<br>
					<div class="panel panel-primary">
  						<!-- Default panel contents -->
 							 <div class="panel-heading " id="testHead"><b>Company List</b></div>
  					
					<div class="list-group" id="listTest" >
  						<button type="button" class="list-group-item" onclick="loadCompany()">Loading Company</button>
					</div></div>
					<button type="button" id="btnNew" class="btn btn-info"  data-toggle="modal" data-target="#myModal">Create New Company</button>
				</div>
				<div class="col-lg-9 col-md-9 col-sm-3">
					&nbsp;<h1 id="CompanyTitle">Select a Company</h1>&nbsp;
					<ul class="nav nav-tabs">
  						<li role="presentation" class="active" id="generalTab" section="generalSection"><a href="#">General</a></li>
  						<li role="presentation" id="EfieldTab" section="EfieldSection"><a href="#">Add Employees</a></li>
  						<!--li role="presentation" id="addTab" section="addSection"><a href="#">Add Employees</a></li-->
  						<li role="presentation" id="viewTab" section="viewSection"><a href="#">View Employee</a></li>
						<li role="presentation" id="payRollTab" section="payRollSection"><a href="#">PayRoll</a></li>
					</ul>
					<div id="generalSection" class="section"><br><span id="settings" class="glyphicon glyphicon-cog"></span>
						<!--p>Number of Employess : 121</p>
						<p>Date Of Next Payment : 1 Oct 2016</p-->
						<table id="generalTable" class="table table-bordered">
						</table>
					</div>
					<div id="EfieldSection" class="section">
					<div>
						&nbsp;
						<div class="row" id="outer">
							<div class="panel panel-default">
								<div class="panel-heading">Personal Info</div>
								<table class="table table-striped table-bordered" id="tablePersonal">
									<tr class="inputGroupInfo">
										<td> Employee Name:</td><td> <input type="text" placeholder="Enter name" name="name" id="pVal1"/>
											
											</tr><tr><td>Employee ID: </td><td><input type="text" placeholder="Enter ID" name="employeeId" id="pVal2"/>
											
											</tr><tr><td>Date of Join:</td><td> <input type="text" placeholder="Enter a date" name="date" id="pVal3"/>
											
											</tr><tr><td>Password:</td><td> <input type="password" placeholder="Enter password" name="password" id="pVal4"/>
											</tr><tr><td>Is this employee an admin? </td><td> <input type="checkbox" name="isAdmin" id="pVal5"/>
										</td></tr>
								</table>
							</div>
						&nbsp;
							<div class="panel panel-default">
								<div class="panel-heading">Salary Info <span class="glyphicon glyphicon-plus add" id="addSalary"></span></div>
								<table class="table table-striped table-bordered" id="tableSalary">
									<!--tr class="inputGroupSalary" >
										<td><input type="text" class="form-control" placeholder="type 1" name="stype1"/></td>
										<td><label class="control-label"><input type="checkbox" value="isPercent" name="ispercent" class="ispercent"/> ispercent</label> </td>
										<td><label class="control-label"><input type="radio" value="addition" name="adjustment1" checked /> Addition </label></td> 
										<td><label class="control-label"><input type="radio" value="redution" name="adjustment1"/> 	Reduction </label></td>
									</tr-->
								</table>
							</div>
							<button  class="btn btn-primary btn-block" style="margin-left:20%; width:60%"id="esubmit">Add Employee</button>
						</div>
						</div>
					</div>
					<div id="addSection"  class="section"><br>
						<!--div class="alert alert-danger" role="alert">
							<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
							<span class="sr-only">Error:</span>
								Please Enter the feilds for employee first
						</div>
						<button id="btnCreateInAddSection" class="btn btn-warning">Create Feilds</button-->
						<div class="panel panel-default">
				  			<div class="panel-heading">Add Employee <span class="glyphicon glyphicon-plus add" id="addNewEmpIcon"></span> </div>
							<table class="table" id="tableAddEmp">
							</table>
                            <button class="btn btn-primary btn-block" style="margin-left:20%; width:60%" id="submit">Submit</button>
						</div>
					</div>
					<div id="viewSection" class="section"><br>
						<div class="panel panel-default">
				  			<div class="panel-heading">Employees <span class="glyphicon glyphicon-minus add" id="deleteEmpIcon"></span></div>
								<table class="table table-striped" id="empTable">
									<thead>
								      		<tr>
												<th>sno</th>
												<th>Name</th>
												<th>Father Name</th>
												<th>DOB</th>
												<th>DOJ</th>
												<th>Designation</th>
												<th>Qualification</th>
								      		</tr>
								   	</thead>
								   
								  	<tbody>
								      		<tr>
												<td>1</td>
												<td>Ram</td>
												<td>Raj</td>
												<td>DD-MM-YYYY</td>
												<td>DD-MM-YYYY</td>
												<td>Assistant Director</td>
												<td>BBA</td>
								      		</tr>
								      
								      		<tr>
												<td>2</td>
												<td>Guna</td>
												<td>Lokesh</td>
												<td>DD-MM-YYYY</td>
												<td>DD-MM-YYYY</td>
												<td>Director</td>
												<td>MBA</td>
								      		</tr>
								      		<tr>
												<td>3</td>
												<td>Bharath</td>
												<td>rehan</td>
												<td>DD-MM-YYYY</td>
												<td>DD-MM-YYYY</td>
												<td>Accountant</td>
												<td>MCOM</td>
								      		</tr>
								      		<tr>
												<td>1</td>
												<td>RAM</td>
												<td>RAJ</td>
												<td>DD-MM-YYYY</td>
												<td>DD-MM-YYYY</td>
												<td>Assistant Director</td>
												<td>BBA</td>
								      		</tr>
								      		<tr>
												<td>5</td>
												<td>bilal</td>
												<td>rasique</td>
												<td>DD-MM-YYYY</td>
												<td>DD-MM-YYYY</td>
												<td>Sales</td>
												<td>BBA</td>
								      		</tr>
								   	</tbody>
  								</table>
							</div>
					</div>
					<div id="payRollSection" class="section">
						<div class="panel panel-default">
							<div class="panel-heading">PayRoll</div>
							Select month <input type="date" id="payrollDate">
							<button onclick="displayPayroll()">Go</button>
							<table class="table  table-striped table-bordered" id="tablePayRoll">
							</table>
						</div>
					</div>
				</div>
			</div>	
		</div>
<!-- Modal -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  			<div class="modal-dialog" role="document">
   				 <div class="modal-content">
      					<div class="modal-header">
        					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
          						<span aria-hidden="true">&times;</span>
   	     					</button>
        					<h4 class="modal-title" id="myModalLabel">New Company</h4>
      					</div>
      					<div class="modal-body">
      						<input type="text" class="form-control" placeholder="Company Name" id="cname"><br>
						<!--input type="text" class="form-control" placeholder="IT Month" id="citmonths"><br>
						<input type="text" class="form-control" placeholder="Shifts" id="cshifts"><br>
						<input type="text" class="form-control" placeholder="Paid Leave" id="f"><br>
						<input type="text" class="form-control" placeholder="Working Hours" id="g"><br>
						<input type="text" class="form-control" placeholder="Number of Departments" id="h"><br>
						<!-div id="ComapanyType">Type</div-->
      					</div>
      					<div class="modal-footer">
        					<button type="button" class="btn btn-secondary" data-dismiss="modal" id="newCompanyClose">Close</button>
        					<button type="button" class="btn btn-primary" id="btnCreateNew" >Save changes</button>
      					</div>
    				</div>
  			</div>
		</div>
        <div id="notification" class="container-fluid">
            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4" id="notificationArea"></div>
                <div class="col-md-4"></div>
            </div>
        </div>
	</body>
	<style>
		#panel{
			background-color:#f1f1f1;
			cursor: pointer;
		}
		#test{ 
			position: absolute;
			width: 100%;
			height: 100%;
			background-color:aqua;
		}
		#top{
			height:80px;
			background-color:#455a64;
			padding-left:5%;
			padding-top:15px;
			color: #fff;
			font-size: 34px;
			
		}
		#newTestOuter{
			padding-top:5%;
		}
		#quesplane{
			padding:2%;
		}
		#submitDiv{
			width:100%;
			text-align:center;
		}
		#btnSubmit{
			background-color:#00AE6D;
			text-transform: uppercase;
			outline: 0;
  			background: #4CAF50;
  			width: 100%;
  			border: 0;
  			padding: 15px;
  			color: #FFFFFF;
  			font-size: 14px;
  			-webkit-transition: all 0.3 ease;
  			transition: all 0.3 ease;
  			cursor: pointer;
			border-radius: 6px;
		}
		#btnNew{
			width:100%;	
		}
		#testHead{
			size:19px;
		}
		#modalNotification{
			width:100%;
			text-align:center;
		}
		#btnSubmit{
			width:300px;
		}
		#settings{
			position: static;
			float: right;
			font-size:20px;
			color:#666;
			cursor: pointer;
		}
		#settings:hover{
			color:#59F;
		}
		#btnCreateInAddSection{
			margin-top: 90px;
			margin-left: 45%;
		}
		.menu{
			position: static;
			float: right;
			margin-top: 7px;
			margin-right: 7px;
			}
		.add{
			position: static;
			float: right;
			font-size:20px;
			color:#666;
			cursor:pointer;
		}
		.add:hover{
			color:#59F;
		}
		body{
			font-family:'Segoe UI';
		}
	</style>
	<script>
		var ecount=1;//Add employee count
		var th = $("#test").height();
		var toph = $("#top").height();
		$("#test").hide();
		$("#panel").height(th-toph);
		
			
		$(".nav-tabs li").on("click",function(){
			$(".nav-tabs li").removeClass("active");
			$(".section").hide();
			$("#"+$(this).attr("section")).show();
			$(this).addClass("active");
		});
		loadCompany();
		//loadGeneral('{"Employees count":"100","Date of Next Payment":"1-12-2016"}');
		//loadEmployees('[{"name":"sk","father name":"sekhar","DOB":"1-2-1996","Designation":"Director"},{"name":"none","father name":"nonedad","DOB":"1-4-1994","Designation":"Assistant"},{"name":"Mr X","father name":"Mr X dad","DOB":"1-2-2001","Designation":"Manager"}]');
		//loadAddEmployees('[{"fields":"Name"},{"fields":"FatherName"},{"fields":"Dob"},{"fields":"BasicPay"}]');
		
		function loadCompany() {
		    $.get("api/listcompanies", {}, function (result) {
		        // alert(result.message);
		        if (result.message != "Success") {
		            companyList =  ' <button type="button" class="list-group-item disabled">' + result.message + '</button> ';
		            $("#listTest").html(companyList);
		            return;
		        }
		        var obj = result.data;
		        var companyList="";
		        for( a in obj )
		            companyList = companyList + ' <button type="button" onclick="companyClick(this)" cid="' + obj[a].CompanyId + '" class="list-group-item" ctitle="' + obj[a].CompanyName + '">' + obj[a].CompanyName + '</button> ';
		        $("#listTest").html(companyList);
		    });
		}
		function loadGeneral(jsonGeneral) {
			var p = JSON.parse(jsonGeneral);
			s1 = "";
			for (var key in p ) {
				if (p.hasOwnProperty(key)){
					//console.log(key + " ->> " + p[key]); 
					s1 = s1 + "<tr> <td>" + key + "</td><td>" + p[key] + "</td></tr>";
				}
				$("#generalTable").html(s1);
			}
		}
		
		function loadEmployees(a){
			var p1 = JSON.parse(a);
			s1 = "";
			h1 = "<thead><tr>";
			for (i in p1 ){
				p = p1[i];
				s1 = s1 + "<tr>";
				for (var key in p ) {
					if (p.hasOwnProperty(key)){
						if ( i==0 ){
							h1 = h1 + "<th>" + key + "</th>";
						}
					    //console.log(key + " ->> " + p[key]); 
						if (key != "salary") {
						    s1 = s1 + "<td>" + p[key] + "</td>";
						} else {
						    s = loadSalary(p[key]);
						    s1 = s1 + "<td>" + s + "</td>";
						}
					}
				}
				s1 = s1 + "</tr>";
			}
			h1 = h1 + "</tr></thead>";
			$("#empTable").html(h1 + s1);
		}
		function loadSalary(p1) {
		   // console.log(p1);
		    var s = "";
		    for (i in p1) {
		        p = p1[i];
		        console.log(p);
		            s = s + p.name + " : " + p.value + " , ";
		    }
		    return s;
		}
		var modalAddEmp ;
		function loadAddEmployees(a){
			var obj = JSON.parse(a);
			s = '<tr>';
			//alert(Object.keys(obj).length);
			modalAddEmp = obj;
			for ( i in obj ) {
				s = s + "<th>"+ obj[i].fields + "</th>";
			}
			s = s + "</tr>";
			$("#tableAddEmp").html(s);
		}

		$("#addNewEmpIcon").on("click",function(){
			s = '<tr>';
			obj = modalAddEmp;
			for ( i in obj ) {
				s = s + '<td><input type="text"  class="form-control" id="'+obj[i].fields+ecount+'" placeholder="'+ obj[i].fields+' ' +ecount+ '"</td>';
			}	
			s = s + "</tr>";
			$("#tableAddEmp").append(s);
			ecount++;
		});
		/*addEmployeeDone
		$("#submit").on("click", function () {
		    obj = modalAddEmp;
		    empAddDone = {};
		    j = 1;
		    while(j<ecount){ 
		        for (i in obj) {
		            empAddDone[obj[i].fields] = $("#" + obj[i].fields + j).val();
		        }
		        j++;
			}
		   
		    alert(JSON.stringify(empAddDone));
		});
        */
		
		
		
		$("#deleteEmpIcon").on("click",function(){
		
			if(count>1){
				//remove code
				//count--;
				}
			else {
				//alert("No Employees to remove");
				}
			
		});
		function companyClick(a) {
		    c = a.getAttribute("cid");
			setCookie("CompanyId", c);
			document.getElementById("CompanyTitle").innerHTML = a.getAttribute("ctitle");
		    $.get("/api/employeeview", { token: getCookie("Token"),CompanyId: c }, function (result) {
		        // alert(result.message);
		        arr = result.data;
				var d = new Date();
				loadGeneral('{"Employees count":"' + arr.length + '","Next Payment":"1-11-2016"}');
		        loadEmployees(JSON.stringify(arr));
		    });
		}
		
		function displayPayroll() {
			$.get("api/payrollhistory", { token: getCookie("Token"), CompanyId: getCookie("CompanyId"), month: document.getElementById("payrollDate").value}, function (result) {
		        notify(result.message);
		        if (result.message == "Success") {
					//Todo: add displaying to table
					loadPayRoll(result.data);
		        }
		    });
		}
		
		function loadPayRoll(a){
			s1 = "";
			h1 = "<thead><tr>";
			p1 = a;
			for (i in p1 ){
				p = p1[i];
				s1 = s1 + "<tr>";
				for (var key in p ) {
					if (p.hasOwnProperty(key)){
						if ( i==0 ){
							h1 = h1 + "<th>" + key + "</th>";
						}
						//console.log(key + " ->> " + p[key]); 
						if(key != "salary" ){
							s1 = s1 + "<td>" + p[key] + "</td>";
						}  	else {
						    s = loadSalaryAndCalc(p[key]);
						    s1 = s1 + "<td>" + s + "</td>";
						}
					}
				}
				s1 = s1 + "</tr>";
			}
			h1 = h1 + "</tr></thead>";
			$("#tablePayRoll").html(h1 + s1);
		}
		function loadSalaryAndCalc(p1) {
		   // console.log(p1);
		    var s = "";
			var dud = 0, inc = 0;
		    for (i in p1) {
		        p = p1[i];
		        console.log(p);
		            s = s + p.name + " : " + p.value + " , ";
					//p.value = Number(p.value);
					console.log(typeof p.value)
					if (p.type == "+"){
						inc = inc + p.value;
						
					}else if (p.type == "-"){
						dud = dud + p.value;
						//console.log(dud);
					}
		    }
			s = s + "inc = "+ inc.toString() + ", Deductions = " + dud.toString() + ", Total ="  + (inc - dud).toString();
		    return s;
		}
		$("#generalTab").trigger("click");
		$("#btnCreateNew").on("click", function () {
		    var name = $("#cname").val();
		    $.get("/api/addcompany", {token: getCookie("Token"), companyname: name}, function(result) {
		            notify(result.message);
					loadCompany();
		    });
		});
		$("#signOut").on("click", function () {
		    deleteCookie();
		    //alert(getCookie("Token"));
		    window.location = "first.html";
		});
		$("#username").html(getCookie("Uname"));
		//validate();
        //alert($("#fsdfsdf"))
        

	</script>
	<script>
		var count=0;//Salary field count
		var cnt=0;//Personal field count
		var th = $("#test").height();
		var toph = $("#top").height();
		$("#test").hide();
		$("#addSalary").on("click", function(){ 
			
			s=`<tr class="inputGroupSalary" id="sal"`+count+`>
							<td><input type="text" class ="form-control" placeholder= "type `+count+`" id= "stype`+count+`" /></td>
                            <td><input type="text" class ="form-control" placeholder= "val `+count+`" id= "sval`+count+`" /></td>
							<td><label class="control-label"><input type="checkbox" value="isPercent" id="ispercent`+count+`" class="ispercent"/> ispercent </label></td>
							<td><label class="control-label"><input type="radio" value="" name="adjustment`+count+`" checked /> Addition</label> </td> 
							<td><label class="control-label"><input type="radio" value="-" name="adjustment`+count+`"/> Deduction </label></td>

						</tr>`;
			$("#tableSalary").append(s);
			count++;
		});
		
		$("#esubmit").on("click",function(){
		    obj = {};
		    obj["name"] = $("#pVal1").val();
			obj["employeeId"] = $("#pVal2").val();
			obj["companyId"] = parseInt(getCookie("CompanyId"));
			obj["date"] = $("#pVal3").val();
			obj["password"] = $("#pVal4").val();
			obj["isAdmin"] = (document.getElementById("pVal5").checked) ? "y" : "n";
		    var arr = new Array();
		    
		    for (i = 0 ; i < count ; i++) {
		        objSal = {};
		        objSal.name = $("#stype" + i).val();
		        //add adjustment to val
		        var ad = $("input[name='adjustment" + i + "']:checked").val() + $("#sval" + i).val();
		        objSal.value = parseFloat(ad);
		        tpe = "#";
		        if ($("#ispercent" + i).is(":checked") ){
		            tpe = "%";
		        }
		        objSal.type = tpe;
                arr.push(objSal);
		    }
		    obj.salary = arr;
		    var jsondata = JSON.stringify(obj);
		    alert(jsondata);
		    $.get("/api/addemployee", { token: getCookie("Token"), employeeJson: jsondata }, function (result) {
		        notify(result.message);
		    });
		});
	</script>
</html>
